env:
  global:
    # directory containing the project source
    - REPO_DIR=.
    # pip dependencies to _build_ project
    - BUILD_DEPENDS=
    # pip dependencies to _test_ project
    - TEST_DEPENDS="tox"
    - PLAT=x86_64
    - UNICODE_WIDTH=32
    # encrypted credentials for uploading packages to PyPI using twine
    - TWINE_USERNAME="anthrotype"
    - secure: UHQZfyYH2TyY35Nhg78TzgKr4lfTYkPYsglM5PejBdALx/pukcyHkBH5qXYlfppYYG1bpVQlsZ1cZ7fBJS9mdNxrEpcWAHybCKSRFkCKark8ansQw68mE7pQdtMMgtj26+MeJZnSko9bg8yp8J8odJju9vxYOQpRzI8WgSeXh9hK6glgAV4QU3Q61zJcOaximPnuZ5jp1CN/l5DFv3NZoZvXZOocqEybjSinyhXsTWIr311GUnfoJEG1t88z7aEpi/vzhlYGvC14d3XXhGcAHPi5qkWuROY/Qb+BwZJb5KryxPo7+Hm8Kph0NcsMxFCDl2MpruxVAtNiQ4qcibNzF0LIREqyYTvGvrafNPp+eDE1DKqoDRSiX4BFlhNZXa3Z3rI0xfRSwBNO2Eb7H/v7+D/BkeP5WgMuA8EEcHELmHbJg0Y9xwkTqLEqy3Mi+PgGuBKOOq8wy9binsN4OmZwhNKNV908jl16ErDzoDm+B1iQbtJbkzmQOMLNo7lPQ3p55ZYqfIqXYT9/yGa4do+eTyRLx8bmUqzN8tFA6iXuxabAMpRuOjhUUglM5K6iaH8iqLapkUCLbleQvG39eZGoPCfukIOLLGf7aNaCa1ZWzOKz6+g8oQJyGhGKEj3apd8+uvvjh1u3Jzi+9ChN0Yq4wb9X4EU1p1xS5Wd/76NFDgk=

language: generic
dist: xenial
services: docker

matrix:
  include:
    # PyPy is not supported yet by multibuild and the manylinux1 container,
    # thus we install PyPy ourselves and run the tests, but don't upload any
    # wheel to Github/PyPy, as they won't be portable across distros.
    # We use pyenv to install the current pypy, as Travis version is outdated
    - os: linux
      env:
        - PYPY_VERSION=5.6.0
        - TOXENV=pypy
        - SKIP_DEPLOY=true
    - os: linux
      env: MB_PYTHON_VERSION=2.7
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.5
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.5
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.7
        - BUILD_SDIST=true
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.7
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.8
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.8
        - PLAT=i686
    - os: osx
      env:
        - MB_PYTHON_VERSION=2.7
    - os: osx
      env:
        - MB_PYTHON_VERSION=3.5
    - os: osx
      env:
        - MB_PYTHON_VERSION=3.6
    - os: osx
      env:
        - MB_PYTHON_VERSION=3.7
    - os: osx
      env:
        - MB_PYTHON_VERSION=3.8

before_install:
  - >-
    if [ -n "$MB_PYTHON_VERSION" ]; then
        source multibuild/common_utils.sh;
        source multibuild/travis_steps.sh;
        before_install;
    elif [ -n "$PYPY_VERSION" ]; then
        deactivate
        export PYENV_ROOT="$(pwd)/.pyenv";
        git clone --depth 1 https://github.com/yyuu/pyenv.git "$PYENV_ROOT"
        export PATH="$PYENV_ROOT/bin:$PATH";
        eval "$(pyenv init -)";
        pyenv install pypy-$PYPY_VERSION;
        pyenv global pypy-$PYPY_VERSION;
        pyenv rehash;
        pypy --version;
        pip install $TEST_DEPENDS;
    fi

install:
  - if [ -n "$MB_PYTHON_VERSION" ]; then build_wheel $REPO_DIR $PLAT; fi

script:
  - >-
    if [ -n "$MB_PYTHON_VERSION" ]; then
        install_run $PLAT;
    else
        tox;
    fi

after_success:
  # if tagged commit, create the source distribution for the deploy stage, and
  # copy the wheel to dist/ where we can upload both to PyPI/Github
  - |
    if [ -n "$TRAVIS_TAG" ] && [ "$TRAVIS_REPO_SLUG" == "obp/py-zopfli" ] && [ "$SKIP_DEPLOY" != true ]; then
        mkdir -p dist
        cp wheelhouse/*.whl dist
        pip install --upgrade twine
        twine upload dist/*.whl
        if [ "$BUILD_SDIST" == true ]; then
            pip install --upgrade setuptools
            python setup.py sdist
            twine upload dist/*.zip
        fi
    fi

deploy:
  # Deploy on tags to GitHub Releases
  - provider: releases
    api_key:
      secure: LNXMnptmp5UkjDfhg7K0zmEr2aJbrguuzzY3NAoQXKyJyKdy4WOMVei+J2WsZfz5j5mWjKOOyaS3u9W9s1xhF1dTOtoxtJv6fvFbiTkaELM7z6kOLPuJYYf3lrxypN2ekGpjDwBaFhh/Av7J7LhR4zfEnXvk3ZZZ/3zURWmVHzvKLzMdwwowryhGZ+UHFB1raAg9IWQi1G5E6ieCRb9/BEqQ70vZvyIBM385Rb+CqMpLMlbig7qKWyJuS0n9ya1RCl5nd4ceI65ZY93C4XkiZB6h9yJLGhpRDfLp++vzk6gAWnwZMSF149lsMA/MoHhF4paIjqYxmxLEmtOH1uKOZo/nwDcGByuDfMKCgD8tKijeO1pS+6YXAuNF2yIVL0SHGzqTeT5XHTDS/jrxed+HLUP9tg5Be5mMDpDHcKU98aU534AD5DaSJ2gisYaguK8svxtfOSNpcr+eK7WOLvbmbrlExnPwSnvwn6wIsGbv194mUqRpZyE7utBvBDC/KOAVJWW2CfmHYrgfoAcNQfWC10fZPzOFg1jHDh7jAg3sIXbEy1ZMlxEretpTtKk4pYDfj8MUZLFzaUppAUwqyhbbNIyAh8VTUxpJVw9eflWI6REHYb97u0FdlmugioHI+ggYMwfNcUsm0B3Qb8Fm+3YvcJ50omiyBJMsaESPEInv15Q=
    file_glob: true
    file: "dist/*"
    skip_cleanup: true
    on:
      repo: obp/py-zopfli
      tags: true
      condition: $SKIP_DEPLOY != true
